<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-------------------------------------------------------------->
<!-- qLibc Project                                            -->
<!--                                                          -->
<!--            Copyright (c) The qDecoder Project            -->
<!--                 http://www.qdecoder.org                  -->
<!-------------------------------------------------------------->

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
  <title>qlibc: ipc/qsem.c File Reference</title>
  <link href="tabs.css" rel="stylesheet" type="text/css"/>
  <link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>

<body>
<center><h1>qLibc API Reference</h1></center>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>ipc/qsem.c File Reference</h1>  </div>
</div>
<div class="contents">
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Semaphore APIs. </p>
<dl class="note"><dt><b>Note:</b></dt><dd><div class="fragment"><pre class="fragment">   [daemon main]
<span class="preprocessor">   #define MAX_SEMAPHORES (2)</span>
<span class="preprocessor"></span>
   <span class="comment">// create semaphores</span>
   <span class="keywordtype">int</span> semid = <a class="code" href="qsem_8c.html#ac66cb18076dd21f67ac4b9a5b246d2d2" title="Initialize semaphore.">qsem_init</a>(<span class="stringliteral">&quot;/some/file/for/generating/unique/key&quot;</span>, <span class="charliteral">&#39;q&#39;</span>, MAX_SEMAPHORES, <span class="keyword">true</span>);
   <span class="keywordflow">if</span>(semid &lt; 0) {
     printf(<span class="stringliteral">&quot;ERROR: Can&#39;t initialize semaphores.\n&quot;</span>);
     <span class="keywordflow">return</span> -1;
   }

   <span class="comment">// fork childs</span>
   (... child forking codes ...)

   <span class="comment">// at the end of daemon, free semaphores</span>
   <span class="keywordflow">if</span>(semid &gt;= 0) <a class="code" href="qsem_8c.html#ab73d1cc1e7a82ce1b4b119ff56d25011" title="Release semaphore to system.">qsem_free</a>(semid);

   [forked child]
   <span class="comment">// critical section for resource 0</span>
   <a class="code" href="qsem_8c.html#acd893b0a1a6b390f27621ae0e93a5dd8" title="Turn on the flag of semaphore then entering critical section.">qsem_enter</a>(semid, 0);
   (... guaranteed as atomic procedure ...)
   <a class="code" href="qsem_8c.html#a4904a3e477119a2cf177a23068a58fdd" title="Turn off the flag of semaphore then leaving critical section.">qsem_leave</a>(semid, 0);

   (... some codes ...)

   <span class="comment">// critical section for resource 1</span>
   <a class="code" href="qsem_8c.html#acd893b0a1a6b390f27621ae0e93a5dd8" title="Turn on the flag of semaphore then entering critical section.">qsem_enter</a>(semid, 1);
   (... guaranteed as atomic procedure ...)
   <a class="code" href="qsem_8c.html#a4904a3e477119a2cf177a23068a58fdd" title="Turn off the flag of semaphore then leaving critical section.">qsem_leave</a>(semid, 1);

   [other program which uses resource 1]
   <span class="keywordtype">int</span> semid = <a class="code" href="qsem_8c.html#aac470476fa8ecdc4cd9ec9596d3d6ca4" title="Get semaphore identifier by keyfile and keyid for the existing semaphore.">qsem_getid</a>(<span class="stringliteral">&quot;/some/file/for/generating/unique/key&quot;</span>, <span class="charliteral">&#39;q&#39;</span>);
   <span class="keywordflow">if</span>(semid &lt; 0) {
     printf(<span class="stringliteral">&quot;ERROR: Can&#39;t get semaphore id.\n&quot;</span>);
     <span class="keywordflow">return</span> -1;
   }

   <span class="comment">// critical section for resource 1</span>
   <a class="code" href="qsem_8c.html#acd893b0a1a6b390f27621ae0e93a5dd8" title="Turn on the flag of semaphore then entering critical section.">qsem_enter</a>(semid, 1);
   (... guaranteed as atomic procedure ...)
   <a class="code" href="qsem_8c.html#a4904a3e477119a2cf177a23068a58fdd" title="Turn off the flag of semaphore then leaving critical section.">qsem_leave</a>(semid, 1);
</pre></div> </dd></dl>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#ac66cb18076dd21f67ac4b9a5b246d2d2">qsem_init</a> (const char *keyfile, int keyid, int nsems, bool recreate)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize semaphore.  <a href="#ac66cb18076dd21f67ac4b9a5b246d2d2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#aac470476fa8ecdc4cd9ec9596d3d6ca4">qsem_getid</a> (const char *keyfile, int keyid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get semaphore identifier by keyfile and keyid for the existing semaphore.  <a href="#aac470476fa8ecdc4cd9ec9596d3d6ca4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#acd893b0a1a6b390f27621ae0e93a5dd8">qsem_enter</a> (int semid, int semno)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Turn on the flag of semaphore then entering critical section.  <a href="#acd893b0a1a6b390f27621ae0e93a5dd8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#a5993822d89f9f6f36ffcedf95a921be0">qsem_enter_nowait</a> (int semid, int semno)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Try to turn on the flag of semaphore.  <a href="#a5993822d89f9f6f36ffcedf95a921be0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#a023df7733cebc81fc0aa0285772a914d">qsem_enter_force</a> (int semid, int semno, int maxwaitms, bool *forceflag)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Force to turn on the flag of semaphore.  <a href="#a023df7733cebc81fc0aa0285772a914d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#a4904a3e477119a2cf177a23068a58fdd">qsem_leave</a> (int semid, int semno)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Turn off the flag of semaphore then leaving critical section.  <a href="#a4904a3e477119a2cf177a23068a58fdd"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#ac56cd066622f8e9bc669c70e51e8a378">qsem_check</a> (int semid, int semno)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the status of semaphore.  <a href="#ac56cd066622f8e9bc669c70e51e8a378"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="qsem_8c.html#ab73d1cc1e7a82ce1b4b119ff56d25011">qsem_free</a> (int semid)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release semaphore to system.  <a href="#ab73d1cc1e7a82ce1b4b119ff56d25011"></a><br/></td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ac66cb18076dd21f67ac4b9a5b246d2d2"></a><!-- doxytag: member="qsem.c::qsem_init" ref="ac66cb18076dd21f67ac4b9a5b246d2d2" args="(const char *keyfile, int keyid, int nsems, bool recreate)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qsem_init </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>keyid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nsems</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&nbsp;</td>
          <td class="paramname"> <em>recreate</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Initialize semaphore. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>keyfile</em>&nbsp;</td><td>seed for generating unique IPC key </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keyid</em>&nbsp;</td><td>seed for generating unique IPC key </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nsems</em>&nbsp;</td><td>number of semaphores to initialize </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>recreate</em>&nbsp;</td><td>set to true to re-create semaphore if exists</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>non-negative shared memory identifier if successful, otherwise returns -1</dd></dl>
<div class="fragment"><pre class="fragment">   <span class="keywordtype">int</span> semid = <a class="code" href="qsem_8c.html#ac66cb18076dd21f67ac4b9a5b246d2d2" title="Initialize semaphore.">qsem_init</a>(<span class="stringliteral">&quot;/tmp/mydaemon.pid&quot;</span>, <span class="charliteral">&#39;q&#39;</span>, 10, <span class="keyword">true</span>);
</pre></div> 
</div>
</div>
<a class="anchor" id="aac470476fa8ecdc4cd9ec9596d3d6ca4"></a><!-- doxytag: member="qsem.c::qsem_getid" ref="aac470476fa8ecdc4cd9ec9596d3d6ca4" args="(const char *keyfile, int keyid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int qsem_getid </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>keyfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>keyid</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get semaphore identifier by keyfile and keyid for the existing semaphore. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>keyfile</em>&nbsp;</td><td>seed for generating unique IPC key </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>keyid</em>&nbsp;</td><td>seed for generating unique IPC key</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>non-negative shared memory identifier if successful, otherwise returns -1 </dd></dl>

</div>
</div>
<a class="anchor" id="acd893b0a1a6b390f27621ae0e93a5dd8"></a><!-- doxytag: member="qsem.c::qsem_enter" ref="acd893b0a1a6b390f27621ae0e93a5dd8" args="(int semid, int semno)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_enter </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semno</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Turn on the flag of semaphore then entering critical section. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>semno</em>&nbsp;</td><td>semaphore number</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if successful, otherwise returns false</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>If the semaphore is already turned on, this will wait until released </dd></dl>

</div>
</div>
<a class="anchor" id="a5993822d89f9f6f36ffcedf95a921be0"></a><!-- doxytag: member="qsem.c::qsem_enter_nowait" ref="a5993822d89f9f6f36ffcedf95a921be0" args="(int semid, int semno)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_enter_nowait </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semno</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Try to turn on the flag of semaphore. </p>
<p>If it is already turned on, do not wait.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>semno</em>&nbsp;</td><td>semaphore number</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if successful, otherwise(already turned on by other) returns false </dd></dl>

</div>
</div>
<a class="anchor" id="a023df7733cebc81fc0aa0285772a914d"></a><!-- doxytag: member="qsem.c::qsem_enter_force" ref="a023df7733cebc81fc0aa0285772a914d" args="(int semid, int semno, int maxwaitms, bool *forceflag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_enter_force </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semno</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>maxwaitms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool *&nbsp;</td>
          <td class="paramname"> <em>forceflag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Force to turn on the flag of semaphore. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>semno</em>&nbsp;</td><td>semaphore number </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>maxwaitms</em>&nbsp;</td><td>maximum waiting micro-seconds to release </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>forceflag</em>&nbsp;</td><td>status will be stored, it can be NULL if you don't need this information</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if successful, otherwise returns false</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>This will wait the semaphore to be released with in maxwaitms. If it it released by locker normally with in maxwaitms, forceflag will be set to false. But if maximum maxwaitms is exceed and the semaphore is released forcely, forceflag will be set to true. </dd></dl>

</div>
</div>
<a class="anchor" id="a4904a3e477119a2cf177a23068a58fdd"></a><!-- doxytag: member="qsem.c::qsem_leave" ref="a4904a3e477119a2cf177a23068a58fdd" args="(int semid, int semno)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_leave </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semno</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Turn off the flag of semaphore then leaving critical section. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>semno</em>&nbsp;</td><td>semaphore number</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if successful, otherwise returns false </dd></dl>

</div>
</div>
<a class="anchor" id="ac56cd066622f8e9bc669c70e51e8a378"></a><!-- doxytag: member="qsem.c::qsem_check" ref="ac56cd066622f8e9bc669c70e51e8a378" args="(int semid, int semno)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_check </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semno</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the status of semaphore. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>semno</em>&nbsp;</td><td>semaphore number</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true for the flag on, false for the flag off </dd></dl>

</div>
</div>
<a class="anchor" id="ab73d1cc1e7a82ce1b4b119ff56d25011"></a><!-- doxytag: member="qsem.c::qsem_free" ref="ab73d1cc1e7a82ce1b4b119ff56d25011" args="(int semid)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool qsem_free </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>semid</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Release semaphore to system. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>semid</em>&nbsp;</td><td>semaphore identifier</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>true if successful, otherwise returns false </dd></dl>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
<a href="http://www.qdecoder.org/">The qDecoder Project</a>.
Tue Jun 12 2012 07:35:13
</small></address>
</body>
</html>
